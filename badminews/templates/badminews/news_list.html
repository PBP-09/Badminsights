{% extends 'base.html' %}
{% load static %}

{% block title %}BadmiNews - Berita Terbaru{% endblock %}

{% block content %}
{% include 'navbar.html' %}
<div class="max-w-6xl mx-auto">
    <h1 class="text-2xl font-serif">üì∞ BadmiNews</h1>

    <!-- Trending News Section -->
    {% if trending_news %}
    <div class="mb-12">
        <h2 class="text-2xl font-serif font-bold text-primary mb-6">Trending News</h2>
        <div class="grid md:grid-cols-3 gap-6">
            {% for news in trending_news %}
            <div class="bg-surface rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                <div class="aspect-video bg-gray-200 flex items-center justify-center">
                    {% if news.image %}
                    <img src="{{ news.image.url }}" alt="{{ news.title }}" class="w-full h-full object-cover">
                    {% else %}
                    <span class="text-gray-500">No Image</span>
                    {% endif %}
                </div>
                <div class="p-4">
                    <h3 class="text-lg font-bold text-primary mb-2">
                        <a href="{% url 'badminews:news_detail' news.pk %}" class="hover:text-secondary transition-colors">{{ news.title }}</a>
                    </h3>
                    <p class="text-secondary text-sm mb-3">{{ news.content|truncatechars:100 }}</p>
                    <div class="flex items-center justify-between text-xs text-secondary">
                        <span>By {{ news.author.username }}</span>
                        <div class="flex items-center gap-2">
                            <span>üîº {{ news.total_upvotes }}</span>
                            <span>üëÅÔ∏è {{ news.views }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Filter and Sort Section -->
    <div class="bg-surface p-6 rounded-lg shadow-md mb-8">
        <div class="flex flex-col md:flex-row justify-between items-start gap-4">
            <!-- Left side - Create News Button -->
            <div class="flex items-center gap-4">
                {% if user.username == "adminpbpb09" %}
                <button id="create-news-btn" class="bg-accent text-white px-6 py-3 rounded-md hover:bg-opacity-90 transition-colors font-semibold">
                    + Create News
                </button>
                {% endif %}
            </div>

            <!-- Right side - Filters -->
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Search input -->
                <div class="flex-1 md:w-64">
                    <input type="text" id="search-input" placeholder="Search news..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" value="{{ search_query }}">
                </div>

                <!-- Filter buttons -->
                {% if user.username == "adminpbpb09"%}
                <div class="flex gap-2">
                    <a href="?filter=all{% if selected_category %}&category={{ selected_category }}{% endif %}{% if sort_by != 'date' %}&sort={{ sort_by }}{% endif %}" class="{% if filter_type == 'all' %}bg-blue-600{% else %}bg-primary{% endif %} text-white px-4 py-2 rounded-md hover:bg-opacity-90 transition-colors">All News</a>
                    <a href="?filter=my{% if selected_category %}&category={{ selected_category }}{% endif %}{% if sort_by != 'date' %}&sort={{ sort_by }}{% endif %}" class="{% if filter_type == 'my' %}bg-blue-600{% else %}bg-secondary{% endif %} text-white px-4 py-2 rounded-md hover:bg-opacity-90 transition-colors">My News</a>
                </div>
                {% endif %}

                <!-- Sort dropdown -->
                <div class="flex items-center gap-2">
                    <span class="text-secondary text-sm">Sorted by:</span>
                    <select name="sort" onchange="updateSort(this.value)" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                        <option value="date" {% if sort_by == 'date' %}selected{% endif %}>Date</option>
                        <option value="upvotes" {% if sort_by == 'upvotes' %}selected{% endif %}>Upvotes</option>
                    </select>
                </div>

                <!-- Category filter -->
                <div class="md:w-48">
                    <form method="GET" class="flex gap-2">
                        <input type="hidden" name="filter" value="{{ filter_type }}">
                        <input type="hidden" name="sort" value="{{ sort_by }}">
                        <select name="category" id="category-select" onchange="this.form.submit()" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">Semua Kategori</option>
                            {% for category_value, category_name in categories %}
                                <option value="{{ category_value }}" {% if selected_category == category_value %}selected{% endif %}>{{ category_name }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- News List -->
    <div class="grid gap-6" id="news-container">
        {% for news in page_obj %}
        <article class="{% if user.is_authenticated and user in news.read_by.all %}bg-gray-100 border-l-4 border-green-500{% else %}bg-surface{% endif %} p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="md:w-1/3">
                    {% if news.image %}
                    <img src="{{ news.image.url }}" alt="{{ news.title }}" class="w-full h-48 object-cover rounded-md">
                    {% else %}
                    <div class="w-full h-48 bg-gray-200 rounded-md flex items-center justify-center">
                        <span class="text-gray-500">No Image</span>
                    </div>
                    {% endif %}
                </div>
                <div class="md:w-2/3">
                    <h2 class="text-2xl font-bold text-primary mb-2">
                        <a href="{% url 'badminews:news_detail' news.pk %}" class="hover:text-secondary transition-colors">
                            {% if user.is_authenticated and user in news.read_by.all %}‚úì {% endif %}{{ news.title }}
                        </a>
                    </h2>
                    <p class="text-secondary mb-4">{{ news.content|truncatechars:200 }}</p>
                    <div class="flex flex-wrap items-center gap-4 text-sm text-secondary">
                        <span>By {{ news.author.username }}</span>
                        <span>{{ news.date_published|date:"d M Y" }}</span>
                        <span class="bg-primary text-white px-2 py-1 rounded">{{ news.get_category_display }}</span>
                        <span>Views: {{ news.views }}</span>
                        <div class="flex items-center gap-1">
                            <button class="upvote-btn text-red-500 hover:text-red-700" data-news-id="{{ news.pk }}">
                                {% if user.is_authenticated and user in news.upvotes.all %}üîº{% else %}‚¨ÜÔ∏è{% endif %}
                            </button>
                            <span class="upvote-count">{{ news.total_upvotes }}</span>
                        </div>
                        {% if user.is_authenticated and user == news.author %}
                        <div class="flex gap-2">
                            <a href="{% url 'badminews:edit_news' news.pk %}" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600">Edit</a>
                            <form method="POST" action="{% url 'badminews:delete_news' news.pk %}" class="inline" onsubmit="return confirm('Are you sure you want to delete this news?')">
                                {% csrf_token %}
                                <button type="submit" class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600">Delete</button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </article>
        {% empty %}
        <div class="text-center py-12">
            <p class="text-secondary text-lg">Belum ada berita yang tersedia.</p>
            {% if user.is_authenticated %}
            <p class="text-secondary mt-2">Buat berita pertama Anda dengan mengklik tombol "Create News" di atas.</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="flex justify-center mt-8">
        <nav class="flex items-center space-x-2">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-opacity-90">Previous</a>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <span class="px-3 py-2 bg-primary text-white rounded-md">{{ num }}</span>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">{{ num }}</a>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-opacity-90">Next</a>
            {% endif %}
        </nav>
    </div>
    {% endif %}

    <!-- Create News Modal -->
    <div id="create-news-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="p-6">
                    <h3 class="text-lg font-bold text-primary mb-4">Create New News</h3>
                    <form id="create-news-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                            <input type="text" name="title" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Content</label>
                            <textarea name="content" rows="4" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                            <select name="category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                {% for value, name in categories %}
                                <option value="{{ value }}">{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Image (Optional)</label>
                            <input type="file" name="image" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="flex justify-end gap-2">
                            <button type="button" id="cancel-create-btn" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-opacity-90">Create News</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const createNewsBtn = document.getElementById('create-news-btn');
    const createNewsModal = document.getElementById('create-news-modal');
    const createNewsForm = document.getElementById('create-news-form');
    const cancelCreateBtn = document.getElementById('cancel-create-btn');

    // Modal functionality
    if (createNewsBtn) {
        createNewsBtn.addEventListener('click', function() {
            createNewsModal.classList.remove('hidden');
        });
    }

    if (cancelCreateBtn) {
        cancelCreateBtn.addEventListener('click', function() {
            createNewsModal.classList.add('hidden');
        });
    }

    // Close modal when clicking outside
    createNewsModal.addEventListener('click', function(e) {
        if (e.target === createNewsModal) {
            createNewsModal.classList.add('hidden');
        }
    });

    // AJAX create news
    createNewsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(createNewsForm);

        fetch('{% url "badminews:create_news_ajax" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('News created successfully!');
                createNewsModal.classList.add('hidden');
                createNewsForm.reset();
                location.reload(); // Reload to show new news
            } else {
                alert('Error creating news: ' + JSON.stringify(data.errors));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating news');
        });
    });

    // Upvote functionality
    document.querySelectorAll('.upvote-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const newsId = this.dataset.newsId;
            const upvoteCount = this.nextElementSibling;

            fetch(`/badminews/${newsId}/upvote/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.upvoted) {
                    this.textContent = 'üîº';
                } else {
                    this.textContent = '‚¨ÜÔ∏è';
                }
                upvoteCount.textContent = data.upvote_count;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('You need to login to upvote');
            });
        });
    });

    // Sort functionality
    window.updateSort = function(sortValue) {
        const url = new URL(window.location);
        url.searchParams.set('sort', sortValue);
        window.location.href = url.toString();
    };

    // Search functionality
    const searchInput = document.getElementById('search-input');
    let searchTimeout;

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch(this.value);
            }, 300); // Debounce 300ms
        });
    }

    function performSearch(query) {
        const currentUrl = new URL(window.location);
        const params = new URLSearchParams(currentUrl.search);

        if (query.trim()) {
            params.set('search', query.trim());
        } else {
            params.delete('search');
        }

        // Reset to page 1 when searching
        params.delete('page');

        fetch(`${currentUrl.pathname}?${params}`)
            .then(response => response.text())
            .then(html => {
                // Extract news container from response
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newNewsContainer = doc.getElementById('news-container');
                const newPagination = doc.querySelector('.pagination') || doc.querySelector('[class*="justify-center"]');

                if (newNewsContainer) {
                    document.getElementById('news-container').innerHTML = newNewsContainer.innerHTML;
                }

                // Update pagination if exists
                const currentPagination = document.querySelector('.pagination') || document.querySelector('[class*="justify-center"]');
                if (newPagination && currentPagination) {
                    currentPagination.innerHTML = newPagination.innerHTML;
                }

                // Re-attach event listeners for new elements
                attachEventListeners();
            })
            .catch(error => {
                console.error('Search error:', error);
            });
    }

    function attachEventListeners() {
        // Re-attach upvote listeners
        document.querySelectorAll('.upvote-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const newsId = this.dataset.newsId;
                const upvoteCount = this.nextElementSibling;

                fetch(`/badminews/${newsId}/upvote/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.upvoted) {
                        this.textContent = 'üîº';
                    } else {
                        this.textContent = '‚¨ÜÔ∏è';
                    }
                    upvoteCount.textContent = data.upvote_count;
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('You need to login to upvote');
                });
            });
        });
    }
});
</script>
{% endblock %}
