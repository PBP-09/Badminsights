{% extends 'base.html' %}
{% load static %}

{% block title %}Forum Diskusi - SmashTalk{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-12 gap-6">
  <!-- Sidebar -->
  <aside class="md:col-span-3">
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
      <div class="px-4 py-3 border-b">
        <h5 class="font-semibold text-gray-700">Filter &amp; Sortir</h5>
      </div>
      <div class="p-4 space-y-4">
        <!-- Search -->
        <form method="get" class="w-full">
          <div class="flex items-center gap-2">
            <input type="text" name="q" value="{{ query }}" placeholder="Cari postingan..." class="flex-1 px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-200"/>
            <button type="submit" class="px-3 py-2 rounded-lg bg-blue-600 text-white font-medium">üîç</button>
          </div>
        </form>

        <!-- Category -->
        <div>
          <h6 class="text-sm font-semibold text-gray-600 mb-2">Kategori</h6>
          <div class="space-y-2">
            <a href="?{% if query %}q={{ query }}&{% endif %}{% if sort_by %}sort={{ sort_by }}{% endif %}"
               class="block px-3 py-2 rounded-lg text-sm {% if not category %}bg-blue-600 text-white font-semibold{% else %}bg-gray-50 text-gray-700 hover:bg-gray-100{% endif %}">
              Semua Kategori
            </a>

            {% for cat_value, cat_label in categories %}
            <a href="?{% if query %}q={{ query }}&{% endif %}category={{ cat_value }}{% if sort_by %}&sort={{ sort_by }}{% endif %}"
               class="block px-3 py-2 rounded-lg text-sm {% if category == cat_value %}bg-blue-600 text-white font-semibold{% else %}bg-gray-50 text-gray-700 hover:bg-gray-100{% endif %}">
              {{ cat_label }}
            </a>
            {% endfor %}
          </div>
        </div>

        <!-- Sort -->
        <div>
          <h6 class="text-sm font-semibold text-gray-600 mb-2">Urutkan</h6>
          <div class="space-y-2">
            <a href="?{% if query %}q={{ query }}&{% endif %}{% if category %}category={{ category }}&{% endif %}sort=newest"
               class="block px-3 py-2 rounded-lg text-sm {% if sort_by == 'newest' %}bg-blue-600 text-white font-semibold{% else %}bg-gray-50 text-gray-700 hover:bg-gray-100{% endif %}">
              Terbaru
            </a>
            <a href="?{% if query %}q={{ query }}&{% endif %}{% if category %}category={{ category }}&{% endif %}sort=popular"
               class="block px-3 py-2 rounded-lg text-sm {% if sort_by == 'popular' %}bg-blue-600 text-white font-semibold{% else %}bg-gray-50 text-gray-700 hover:bg-gray-100{% endif %}">
              Populer
            </a>
            <a href="?{% if query %}q={{ query }}&{% endif %}{% if category %}category={{ category }}&{% endif %}sort=most_commented"
               class="block px-3 py-2 rounded-lg text-sm {% if sort_by == 'most_commented' %}bg-blue-600 text-white font-semibold{% else %}bg-gray-50 text-gray-700 hover:bg-gray-100{% endif %}">
              Banyak Komentar
            </a>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main content -->
  <section class="md:col-span-9 space-y-6">
    {% if user.is_authenticated %}
    <!-- Tombol buka modal -->
    <div class="flex justify-end mb-4">
      <button id="openCreatePostModal" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition">+ Buat Postingan</button>
    </div>

    <!-- Include modal (modal file must render {{ form }}) -->
    {% include 'create_modal.html' %}
    {% endif %}

    <!-- Stats -->
    <div class="bg-white rounded-lg shadow-sm p-4 flex items-center justify-center">
      <div class="text-center">
        <div id="total-posts-count" class="text-2xl font-semibold text-gray-800">{{ page_obj.paginator.count }}</div>

        <div class="text-sm text-gray-500">Total Postingan</div>
      </div>
    </div>

    <!-- Posts list -->
    <div id="posts-container" class="space-y-4">
      {% for post in page_obj %}
      <article class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="p-5">
          <div class="flex justify-between items-start gap-4">
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-gray-900">
                <a href="{% url 'smash_talk:post_detail' post.pk %}" class="hover:underline">{{ post.title }}</a>
              </h3>
              <div class="mt-2 inline-flex items-center gap-2">
                <span class="px-2 py-1 rounded-md text-xs font-semibold text-white bg-blue-600">{{ post.get_category_display }}</span>
                <span class="text-sm text-gray-500">{{ post.author.username }}</span>
                <span class="text-sm text-gray-400">‚Ä¢</span>
                <time class="text-sm text-gray-400">{{ post.created_at|date:"d M Y H:i" }}</time>
              </div>
            </div>

            <div class="text-right text-sm text-gray-500 whitespace-nowrap">
              <div>üëç <span class="font-semibold text-gray-700">{{ post.total_likes }}</span></div>
              <div class="mt-1">üí¨ <span class="font-semibold text-gray-700">{{ post.total_comments }}</span></div>
            </div>
          </div>

          <p class="mt-4 text-gray-700">{{ post.content|truncatewords:30 }}</p>
        </div>
      </article>
      {% empty %}
      <div class="text-center py-12 text-gray-500">
        <h4 class="text-lg font-medium">Belum ada postingan</h4>
        <p class="mt-2">Jadilah yang pertama membuat postingan!</p>
        {% if user.is_authenticated %}
        <a href="{% url 'smash_talk:create_post' %}" class="inline-block mt-4 px-4 py-2 rounded-lg bg-blue-600 text-white">Buat Postingan Pertama</a>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <nav class="flex justify-center items-center">
      <ul class="inline-flex items-center space-x-2">
        {% if page_obj.has_previous %}
        <li><a href="?page=1{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" class="px-3 py-1 rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200">First</a></li>
        <li><a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" class="px-3 py-1 rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200">Previous</a></li>
        {% endif %}
        <li class="px-3 py-1 rounded-md bg-blue-600 text-white">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</li>
        {% if page_obj.has_next %}
        <li><a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" class="px-3 py-1 rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200">Next</a></li>
        <li><a href="?page={{ page_obj.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}{% if category %}&category={{ category }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" class="px-3 py-1 rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200">Last</a></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </section>
</div>

<script src="{% static 'js/forum.js' %}"></script>
{% endblock %}
